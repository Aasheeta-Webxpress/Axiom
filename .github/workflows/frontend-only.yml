name: ðŸŒ Deploy Flutter Frontend

on:
  push:
    branches: [ main ]

jobs:
  deploy-frontend:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    # Setup Flutter with correct version
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.38.9'
        channel: 'stable'
        cache: true
    
    - name: Setup Flutter Web
      run: |
        flutter --disable-analytics
        flutter config --enable-web
        flutter doctor -v
    
    - name: Install Flutter dependencies
      run: |
        cd axiom
        flutter clean
        flutter pub get --no-prerelease
    
    - name: Build Flutter Web App
      run: |
        cd axiom
        flutter build web --release --verbose
        ls -la build/web/
    
    - name: Create web manifest
      run: |
        cd axiom/build/web
        cat > manifest.json << 'EOF'
        {
          "name": "Axiom Platform",
          "short_name": "Axiom",
          "start_url": "/",
          "display": "standalone",
          "background_color": "#ffffff",
          "theme_color": "#2196F3",
          "description": "No-code platform for building applications"
        }
        EOF
    
    - name: Create service worker
      run: |
        cd axiom/build/web
        cat > sw.js << 'EOF'
        const CACHE_NAME = 'axiom-v1';
        const urlsToCache = [
          '/',
          '/main.dart.js',
          '/index.html',
          '/assets/'
        ];

        self.addEventListener('install', event => {
          event.waitUntil(
            caches.open(CACHE_NAME)
              .then(cache => cache.addAll(urlsToCache))
          );
        });

        self.addEventListener('fetch', event => {
          event.respondWith(
            caches.match(event.request)
              .then(response => {
                return response || fetch(event.request);
              })
          );
        });
        EOF
    
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./axiom/build/web
    
    - name: Create local deployment script
      run: |
        cat > deploy-frontend.sh << 'EOF'
        #!/bin/bash
        echo "ðŸŒ Deploying Flutter Frontend..."
        
        # Build locally
        cd axiom
        flutter build web --release
        
        # Serve locally
        cd build/web
        python3 -m http.server 3000
        
        echo "ðŸŒ Frontend available at: http://localhost:3000"
        EOF
        
        chmod +x deploy-frontend.sh
    
    - name: Create backend Dockerfile (for manual build)
      run: |
        cat > backend-manual-build.sh << 'EOF'
        #!/bin/bash
        echo "ðŸ³ Building Backend Docker Image..."
        
        cd axiomBackend
        docker build -t axiom-backend:latest .
        
        echo "âœ… Backend built locally: axiom-backend:latest"
        echo "ðŸš€ Run with: docker run -p 5000:5000 axiom-backend:latest"
        EOF
        
        chmod +x backend-manual-build.sh
    
    - name: Commit deployment scripts
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add deploy-frontend.sh backend-manual-build.sh
        git commit -m "Add deployment scripts" || exit 0
        git push

  # Health Check
  health-check:
    needs: deploy-frontend
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Check GitHub Pages
      run: |
        echo "ðŸŒ GitHub Pages: https://aasheeta-webxpress.github.io/axiom"
        echo "ðŸ“‹ Flutter web app deployed successfully"
    
    - name: Deployment Summary
      if: success()
      run: |
        echo "ðŸŽ‰ Flutter Frontend Deployed!"
        echo ""
        echo "ðŸ“¦ COMPONENTS:"
        echo "  âœ… Frontend: GitHub Pages (Flutter Web)"
        echo "  âœ… PWA Support: Service Worker + Manifest"
        echo "  âœ… Local Scripts: deploy-frontend.sh + backend-manual-build.sh"
        echo ""
        echo "ðŸŒ LIVE URL:"
        echo "  ðŸŒ GitHub Pages: https://aasheeta-webxpress.github.io/axiom"
        echo ""
        echo "ðŸš€ LOCAL DEPLOYMENT:"
        echo "  ðŸ“‹ Frontend: ./deploy-frontend.sh"
        echo "  ðŸ³ Backend: ./backend-manual-build.sh"
        echo ""
        echo "ðŸ’° TOTAL COST: $0/month!"
